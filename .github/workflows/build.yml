name: Build

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-latest
    if: github.actor == 'jlutukai'

    steps:
      - name: Validate build trigger
        run: |
          if [[ "${{ github.actor }}" != "jlutukai" ]]; then
            echo "Error: Only jlutukai can trigger releases"
            exit 1
          fi

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify tag is on main branch
        run: |
          if ! git branch -r --contains ${{ github.sha }} | grep -q 'origin/main'; then
            echo "Error: Tag must point to a commit on the main branch"
            exit 1
          fi
          echo "Tag is on main branch"

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Calculate version
        id: version
        run: |
          # Extract version from tag (e.g., v1.2.3 -> 1.2.3)
          VERSION_NAME="${GITHUB_REF#refs/tags/v}"

          # Calculate version code from semver: (major * 10000) + (minor * 100) + patch
          IFS='.' read -r major minor patch <<< "$VERSION_NAME"
          VERSION_CODE=$((major * 10000 + minor * 100 + patch))

          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "VERSION_CODE=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION_NAME (code: $VERSION_CODE)"

      - name: Check formatting (Spotless)
        env:
          VERSION_NAME: ${{ steps.version.outputs.VERSION_NAME }}
          VERSION_CODE: ${{ steps.version.outputs.VERSION_CODE }}
        run: ./gradlew spotlessCheck

      - name: Static analysis (Detekt)
        env:
          VERSION_NAME: ${{ steps.version.outputs.VERSION_NAME }}
          VERSION_CODE: ${{ steps.version.outputs.VERSION_CODE }}
        run: ./gradlew detekt

      - name: Run unit tests
        env:
          VERSION_NAME: ${{ steps.version.outputs.VERSION_NAME }}
          VERSION_CODE: ${{ steps.version.outputs.VERSION_CODE }}
        run: ./gradlew testDebugUnitTest

      - name: Build release APK
        env:
          VERSION_NAME: ${{ steps.version.outputs.VERSION_NAME }}
          VERSION_CODE: ${{ steps.version.outputs.VERSION_CODE }}
        run: ./gradlew assembleRelease

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: apk-${{ steps.version.outputs.VERSION_NAME }}
          path: app/build/outputs/apk/**/app-*.apk
          retention-days: 14
